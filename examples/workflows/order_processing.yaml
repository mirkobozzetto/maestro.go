name: order_processing
version: "1.0"
timeout: 60s

services:
  inventory:
    type: grpc
    endpoint: "localhost:50053"
    timeout: 5s
    retry:
      attempts: 3
      backoff: exponential

  payment:
    type: grpc
    endpoint: "localhost:50054"
    timeout: 15s
    retry:
      attempts: 5
      backoff: exponential

  shipping:
    type: grpc
    endpoint: "localhost:50055"
    timeout: 10s

  notification:
    type: http
    endpoint: "http://localhost:3001"
    timeout: 5s

steps:
  - id: reserve_inventory
    service: inventory
    method: ReserveItems
    input:
      order_id: "{{ .input.order_id }}"
      items: "{{ .input.items }}"
    output: reservation
    compensate:
      method: ReleaseReservation
      input:
        reservation_id: "{{ .reservation.id }}"

  - id: process_payment
    service: payment
    method: ChargePayment
    input:
      order_id: "{{ .input.order_id }}"
      amount: "{{ .input.total_amount }}"
      payment_method: "{{ .input.payment_method }}"
      customer_id: "{{ .input.customer_id }}"
    output: payment
    compensate:
      method: RefundPayment
      input:
        payment_id: "{{ .payment.transaction_id }}"
        amount: "{{ .input.total_amount }}"

  - id: confirm_inventory
    service: inventory
    method: ConfirmReservation
    input:
      reservation_id: "{{ .reservation.id }}"
      payment_id: "{{ .payment.transaction_id }}"
    output: inventory_confirmation

  - parallel:
      - id: create_shipment
        service: shipping
        method: CreateShipment
        input:
          order_id: "{{ .input.order_id }}"
          customer_address: "{{ .input.shipping_address }}"
          items: "{{ .input.items }}"
          priority: "{{ .input.shipping_priority }}"
        output: shipment
        compensate:
          method: CancelShipment
          input:
            shipment_id: "{{ .shipment.tracking_number }}"

      - id: send_confirmation
        service: notification
        method: SendOrderConfirmation
        input:
          customer_email: "{{ .input.customer_email }}"
          order_id: "{{ .input.order_id }}"
          items: "{{ .input.items }}"
          total: "{{ .input.total_amount }}"
          payment_status: "{{ .payment.status }}"

  - id: update_inventory_stats
    service: inventory
    method: UpdateStatistics
    input:
      items_sold: "{{ .input.items }}"
      revenue: "{{ .input.total_amount }}"

output:
  order_id: "{{ .input.order_id }}"
  payment_id: "{{ .payment.transaction_id }}"
  shipment_tracking: "{{ .shipment.tracking_number }}"
  estimated_delivery: "{{ .shipment.estimated_delivery }}"
  status: "processed"